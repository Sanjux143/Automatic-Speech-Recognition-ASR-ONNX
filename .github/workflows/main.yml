name: Build SenseVoice ONNX

on:
  push:
    branches:
      - main  # Jab bhi main branch pe commit hoga, ye auto run ho jayega
  workflow_dispatch: # Manual option bhi rakha hai backup ke liye

jobs:
  export_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -U torch torchaudio numpy scipy
          pip install -U funasr modelscope onnxruntime onnx onnxscript
          pip install git+https://github.com/alibaba-damo-academy/FunASR.git

      - name: Export SenseVoice Small
        run: |
          python -c "
          import os
          from funasr import AutoModel
          model_id = 'iic/SenseVoiceSmall'
          output_dir = os.path.abspath('SenseVoice_Export')
          model = AutoModel(model=model_id, device='cpu', trust_remote_code=True)
          try:
              res = model.export(output_dir=output_dir, quantize=False)
              print('Export Successful')
          except Exception as e:
              import traceback
              traceback.print_exc()
              exit(1)
          "

      - name: Prepare Artifacts
        run: |
          mkdir -p final_output
          find SenseVoice_Export -name "*.onnx" -exec cp {} final_output/SenseVoice.onnx \;
          find SenseVoice_Export -name "tokens.json" -exec cp {} final_output/tokens.json \;
          find SenseVoice_Export -name "config.json" -exec cp {} final_output/config.json \;

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SenseVoice_Files
          path: final_output/
