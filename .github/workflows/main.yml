name: Build SenseVoice ONNX

on:
  workflow_dispatch:

jobs:
  export_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -U funasr modelscope torch torchaudio onnxruntime onnx numpy
          pip install git+https://github.com/alibaba-damo-academy/FunASR.git # Latest version for export fixes

      - name: Export SenseVoice Small
        run: |
          python -c "
          import os
          from funasr import AutoModel
          
          # Model ID from ModelScope
          model_id = 'iic/SenseVoiceSmall'
          
          # Load model
          model = AutoModel(model=model_id, device='cpu')
          
          # Export to ONNX
          # SenseVoiceSmall requires specific export parameters
          output_dir = os.path.abspath('SenseVoice_Export')
          res = model.export(output_dir=output_dir, quantize=False)
          print(f'Export finished. Files in: {output_dir}')
          "

      - name: Verify and Organize Files
        run: |
          mkdir -p artifacts
          # SenseVoice export typically creates a subfolder based on model name
          # We search for .onnx and .json files and move them to artifacts
          find SenseVoice_Export -name "*.onnx" -exec cp {} artifacts/SenseVoice.onnx \;
          find SenseVoice_Export -name "tokens.json" -exec cp {} artifacts/SenseVoice_tokens.json \;
          find SenseVoice_Export -name "config.json" -exec cp {} artifacts/config.json \;
          
          echo "Files in artifacts folder:"
          ls -R artifacts

      - name: Upload SenseVoice Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: SenseVoice_ONNX_Mobile
          path: artifacts/
